<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://<%=host%>:3001/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="javascripts/jquery.min.js"></script>
    <title>首页用户聊天框</title>
    <script>
        var sks = [];
        var userSocketIdArr = [];
        // var adminSocketIdArr = [];
        function seLc(o) {
            //send message
            var i = $(o).parent(".lcWrap").index();
            var userMsg = $(o).prev(".lcText").val();
            //append massage to chat panel

            var userMsgShow = $("<div class='userMsgShow'>Yogel:<span class='chatTitle'></span></div>");
            userMsgShow.find("span.chatTitle").text(userMsg);
   
            var findChatPanel = $(o).parent(".lcWrap").find("div.chat-content");
            findChatPanel.append(userMsgShow);

            sks[i].emit("adminLcInstance", {
                userSocketId:userSocketIdArr[i],
                msg:userMsg
            });
        }
    </script>

<script>
$(document).ready(function () {
const host = '<%= host %>';
const socket = io.connect("http://"+ host + ":3001");
// socket = io.connect('http://47.107.184.56:3001');
socket.on("connection");
socket.emit("adminLandingLc",{msg:"Yogel"});

socket.on("lcInstance",function (data) {
    //a new user is on home page, set a new socket instance and html panel to chat
    // alert(data.msg);
    const msg = data.msg;
    const userSocketId = data.userSocketId;
    LcInstance(msg, userSocketId);
    
});


function LcInstance(msg, userSocketId) {
    // alert(msg);
    // alert(userSocketId)
    var socket = io.connect("http://"+ host + ":3001");
    socket.on("connection");

    socket.on("alc",function (data) {
        var lcIndex = 0;
        const msg = data.msg;
        const adminSocketId = data.adminSocketId;

        for(let i = 0; i < sks.length; i++){
            if(sks[i].id === adminSocketId){
             
                lcIndex = i;
                break;
            }
        }

        let lvChatbox = $(".lcWrap").eq(lcIndex);

        const lcMsg = $("<span></span>");
        lcMsg.text(msg);

        lvChatbox.find("div.chat-content").append(lcMsg);
    
    });

    socket.on("userCloseLc",function(data){
        console.log(sks);
        const socketId = socket.id;
        const userSocketId = data.userSocketId;
        for(let i = 0; i < sks.length; i++){
            if(sks[i].id === socketId){
                // sks.splice(i, 1);
                sks[i].id = "";
            }
        }
        for(let i = 0; i < userSocketIdArr.length; i++){
            if(userSocketIdArr[i] === userSocketId){
                // userSocketIdArr.splice(i, 1);
                userSocketIdArr[i] = "";
            }
        }
     
        console.log(sks);
        console.log(userSocketIdArr);
    });

    sks.push(socket);
    userSocketIdArr.push(userSocketId);
    // const adminLcSocketId = socket.id;
    // adminSocketIdArr.push(adminLcSocketId);
    // trying to get admin socket id here will be undefined

    const h = $("<div class='lcWrap'>"+
        "<div class='chat-content'></div>"+
        "<textarea class='lcText'></textarea>"+
        "<button class='lcBtn' onclick='seLc(this);'>发送</button>"+
     
        "<div/> ");
    h.appendTo($("#chatPanel"));

}


})
</script>
<style>
    .chat-content{
        border:solid 1px gray;
        padding:2px;
        width:40%;
        height:300px;
    }
</style>
</head>
<body>
    <div id="chatPanel">

    </div>
    <!-- <div>
        <textarea id='indexLc'></textarea>
        <button id="SendMsg">发送</button>
    </div> -->
</body>
</html>